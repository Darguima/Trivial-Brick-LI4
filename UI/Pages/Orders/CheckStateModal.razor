<div class="modal-backdrop fade show"></div>

<div class="modal show d-block" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="text-center mb-3">Order Status #@Order.Order_id</h5>
                @if (!string.IsNullOrEmpty(ProductImageUrl))
                {
                    <img src="@ProductImageUrl" alt="Assembly State Image" class="img-fluid" />
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger text-center">@errorMessage</div>
                }
                else
                {
                    <p class="text-center">Loading image...</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Order Order { get; set; } = default!;
    [Parameter] public EventCallback OnClose { get; set; }

    private string? errorMessage;
    private string? ProductImageUrl { get; set; }
    private Timer? _timer;
    private bool _isDisposed;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductImage();
        _timer = new Timer(async _ => await InvokeAsync(LoadProductImage), null, 0, 1000);
    }

    private async Task LoadProductImage()
    {
        if (_isDisposed) return;

        try
        {
            var line = await _assembly_lines.GetAssemblyLineByOrder(Order.Order_id);
            if (line == null)
            {
                errorMessage = "No assembly line found for this order.";
                await CloseModalAsync();
                return;
            }

            var instructions = await _catalogs.GetInstructionsByProduct(Order.Product_id);
            if (instructions == null)
            {
                errorMessage = "No instructions found for this product.";
                await CloseModalAsync();
                return;
            }

            var date = DateTime.Now;
            var begin_date = line.Mount_start_time;
            var dif_seconds = begin_date.HasValue ? (date - begin_date.Value).TotalSeconds : (double?)null;

            if (dif_seconds.HasValue)
            {
                for (int i = 0; i < instructions.Count; i++)
                {
                    dif_seconds -= instructions[i].Qnt_parts;
                    if (dif_seconds <= 0)
                    {
                        ProductImageUrl = instructions[i].Image;
                        break;
                    }
                }

                if (dif_seconds > 0)
                {
                    // Order is complete, close the modal
                    await CloseModalAsync();
                }
            }
            else
            {
                errorMessage = "Assembly start time is not available.";
                await CloseModalAsync();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            await CloseModalAsync();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseModalAsync()
    {
        _timer?.Dispose();
        _timer = null;
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

    private void CloseModal()
    {
        CloseModalAsync().ConfigureAwait(false);
    }

    public void Dispose()
    {
        _isDisposed = true;
        _timer?.Dispose();
    }
}